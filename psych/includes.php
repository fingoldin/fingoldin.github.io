<?php

function get_time()
{
	date_default_timezone_set("America/New_York");
        return date("Y-m-d H:i:s");
}

function get_points($phase, $sequence, $answer)
{
	if(!session_id())
		session_start();

	if(!isset($_SESSION["testing_data"]))
		return 0;

	$arr = $_SESSION["testing_data"][$phase][$sequence];
        sort($arr);

        $a = intval($answer);

        $p = 0;

        if($arr[0] == $a)
                $p = 2;
        else if($arr[1] == $a)
                $p = 1;

	return $p;
}

function submit_response($arr)
{
	$conn = dbConnect();

	$result = dbQuery($conn, "INSERT INTO responses SET start_time=:start_time, end_time=:end_time, total_points=:total_points", [
			"start_time" => $arr["start_time"],
			"end_time" => $arr["end_time"],
			"total_points" => $arr["total_points"]
	]);

	$id = $conn->lastInsertId();

	foreach($arr["data"] as $trial)
	{
		if($trial["trial_type"] == "bar-choose")
		{
			foreach($trial["responses"] as $bar_response)
			{
				dbQuery($conn, "INSERT INTO bar_responses SET response=:value, offby=:offby, category=:category, category_index=:category_index, RID=$id, phase=" . $trial["phase"] . ", number=" . $trial["number"], $bar_response);
			}
		}
		else if($trial["trial_type"] == "ticket-choose" && $trial["sequence"] > -1)
		{
//			var_dump($trial);
			dbQuery($conn, "INSERT INTO test_responses SET response=:result, points=:points, phase=:phase, sequence=:sequence, place=:place, RID=$id", [
					"result" => $trial["result"],
					"points" => $trial["points"],
					"phase" => $trial["phase"],
					"sequence" => $trial["sequence"],
					"place" => $trial["place"]
			]);
		}
	}
}

function dbConnect() {
    $dsn = "mysql:host=localhost;dbname=responses;charset=utf8";
    $opts = [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_ERRMODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false,
    ];
    $conn = new PDO($dsn, "root", "root", $opts);
    return $conn;
}
function dbQuery($conn, $query, $values = array()) {
    if (isset($values)) {
        $stmt = $conn->prepare($query);
        $stmt->execute($values);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
    else {
        $stmt = $conn->query($query);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
}

function startSession() {

if(session_id())
{
	/*if(isset($_SESSION["finished"]) && isset($_SESSION["RID"]) && $_SESSION["finished"] == 1)
	{
		$conn = dbConnect();

		dbQuery($conn, "DELETE FROM responses WHERE RID=:rid", ["rid" => $_SESSION["RID"]]);
		dbQuery($conn, "DELETE FROM bar_responses WHERE RID=:rid", ["rid" => $_SESSION["RID"]]);
		dbQuery($conn, "DELETE FROM test_responses WHERE RID=:rid", ["rid" => $_SESSION["RID"]]);
	}*/

       	$_SESSION = array();
       	session_destroy();
}

session_start();

$_SESSION["points"] = 0;
$_SESSION["checked"] = [];
$_SESSION["checked"][0] = $_SESSION["checked"][1] = [];
$_SESSION["got_data"] = 0;
$_SESSION["finished"] = 0;
$_SESSION["checked_assoc"] = [];
$_SESSION["checked_assoc"][0] = $_SESSION["checked_assoc"][1] = [];

$_SESSION["start_time"] = get_time();

$_SESSION["training_data"] = [
[222, 145, 186, 183, 152, 171, 210, 158, 185, 164, 170, 214, 144, 178, 161, 170, 227, 196, 137, 164, 176, 198, 192, 200, 181, 178, 153, 196, 182, 204, 181, 181, 181, 178, 180, 170, 171, 179, 154, 172, 166, 178, 176, 176, 202, 172, 172, 173, 191, 170],
[190, 105, 220, 151, 111, 213, 261, 183, 211, 191, 146, 127, 262, 226, 189, 128, 250, 228, 242, 188, 156, 193, 233, 205, 154, 235, 208, 200, 182, 219, 236, 184, 224, 280, 227, 143, 233, 210, 192, 170, 164, 233, 158, 213, 220, 274, 177, 202, 170, 209]
];

$_SESSION["training_answers"] = [
[1, 3, 8, 4, 3, 1, 0], //[3, 7, 20, 10, 7, 2, 1]
[1, 2, 2, 5, 5, 3, 2] // [4, 4, 6, 12, 13, 7, 4]
];

$_SESSION["testing_data"] = [[
[191, 168, 200, 169, 149, 209, 187, 171, 165, 150],
[183, 213, 138, 190, 186, 209, 178, 194, 165, 193],
[192, 158, 184, 208, 188, 226, 181, 198, 169, 217],
[184, 180, 224, 165, 181, 199, 185, 193, 218, 126],
[165, 163, 166, 201, 185, 179, 156, 204, 202, 214],
[154, 140, 157, 186, 167, 192, 188, 197, 195, 217],
[176, 143, 179, 185, 184, 196, 187, 202, 201, 211],
[154, 145, 155, 168, 161, 185, 173, 191, 188, 199],
[162, 157, 170, 176, 175, 191, 182, 200, 195, 203],
[151, 148, 157, 165, 163, 171, 167, 187, 186, 220],
[195, 194, 190, 224, 188, 193, 164, 161, 173, 187],
[191, 187, 173, 205, 170, 183, 164, 159, 165, 168],
[203, 196, 188, 210, 182, 194, 138, 128, 152, 174],
[210, 196, 183, 213, 182, 184, 160, 149, 162, 179],
[205, 202, 200, 207, 196, 201, 146, 137, 175, 182],
[144, 205, 165, 201, 171, 213, 174, 206, 184, 191],
[155, 197, 162, 187, 169, 208, 173, 206, 174, 181],
[148, 187, 155, 181, 161, 199, 168, 194, 172, 174],
[144, 204, 154, 195, 168, 227, 172, 211, 184, 185],
[154, 190, 165, 188, 172, 200, 174, 198, 177, 180],
[163, 185, 168, 191, 196, 166, 199, 195, 227, 198],
[185, 163, 168, 191, 196, 166, 199, 195, 227, 198],
[185, 168, 163, 191, 196, 166, 199, 195, 227, 198],
[185, 168, 191, 163, 196, 166, 199, 195, 227, 198],
[185, 168, 191, 196, 163, 166, 199, 195, 227, 198],
[191, 168, 200, 169, 149, 209, 187, 171, 165, 150],
[183, 213, 138, 190, 186, 209, 178, 194, 165, 193],
[192, 158, 184, 208, 188, 226, 181, 198, 169, 217],
[184, 180, 224, 165, 181, 199, 185, 193, 218, 126],
[165, 163, 166, 201, 185, 179, 156, 204, 202, 214],
[154, 140, 157, 186, 167, 192, 188, 197, 195, 217],
[176, 143, 179, 185, 184, 196, 187, 202, 201, 211],
[154, 145, 155, 168, 161, 185, 173, 191, 188, 199],
[162, 157, 170, 176, 175, 191, 182, 200, 195, 203],
[151, 148, 157, 165, 163, 171, 167, 187, 186, 220],
[195, 194, 190, 224, 188, 193, 164, 161, 173, 187],
[191, 187, 173, 205, 170, 183, 164, 159, 165, 168],
[203, 196, 188, 210, 182, 194, 138, 128, 152, 174],
[210, 196, 183, 213, 182, 184, 160, 149, 162, 179],
[205, 202, 200, 207, 196, 201, 146, 137, 175, 182],
[144, 205, 165, 201, 171, 213, 174, 206, 184, 191],
[155, 197, 162, 187, 169, 208, 173, 206, 174, 181],
[148, 187, 155, 181, 161, 199, 168, 194, 172, 174],
[144, 204, 154, 195, 168, 227, 172, 211, 184, 185],
[154, 190, 165, 188, 172, 200, 174, 198, 177, 180],
[163, 185, 168, 191, 196, 166, 199, 195, 227, 198],
[185, 163, 168, 191, 196, 166, 199, 195, 227, 198],
[185, 168, 163, 191, 196, 166, 199, 195, 227, 198],
[185, 168, 191, 163, 196, 166, 199, 195, 227, 198],
[185, 168, 191, 196, 163, 166, 199, 195, 227, 198]
], [
[219, 222, 305, 181, 165, 170, 188, 187, 195, 215],
[141, 225, 160, 141, 198, 266, 199, 228, 194, 187],
[187, 209, 264, 118, 159, 171, 162, 210, 177, 254],
[207, 196, 268, 185, 208, 135, 158, 108, 148, 192],
[229, 246, 217, 177, 185, 235, 191, 237, 179, 232],
[156, 140, 159, 216, 191, 228, 217, 239, 231, 254],
[151, 30, 153, 170, 155, 193, 175, 253, 242, 290],
[156, 125, 185, 212, 206, 235, 234, 250, 244, 284],
[169, 153, 180, 208, 197, 214, 211, 236, 216, 243],
[139, 123, 159, 188, 166, 199, 191, 244, 211, 254],
[225, 224, 216, 265, 207, 218, 169, 154, 174, 202],
[269, 260, 238, 292, 226, 255, 167, 150, 189, 208],
[232, 221, 189, 245, 182, 203, 144, 114, 147, 160],
[226, 207, 202, 270, 199, 204, 158, 134, 178, 194],
[232, 227, 213, 234, 207, 224, 180, 152, 182, 200],
[138, 234, 141, 218, 168, 271, 169, 248, 193, 198],
[117, 218, 158, 198, 161, 293, 165, 252, 181, 182],
[151, 242, 167, 231, 187, 254, 192, 245, 195, 208],
[107, 207, 123, 198, 135, 237, 157, 213, 168, 186],
[165, 223, 169, 219, 189, 267, 191, 264, 192, 195],
[115, 171, 154, 181, 226, 123, 245, 189, 251, 237],
[171, 115, 154, 181, 226, 123, 245, 189, 251, 237],
[171, 154, 115, 181, 226, 123, 245, 189, 251, 237],
[171, 154, 181, 226, 226, 123, 245, 189, 251, 237],
[171, 154, 181, 115, 115, 123, 245, 189, 251, 237],
[219, 222, 305, 181, 165, 170, 188, 187, 195, 215],
[141, 225, 160, 141, 198, 266, 199, 228, 194, 187],
[187, 209, 264, 118, 159, 171, 162, 210, 177, 254],
[207, 196, 268, 185, 208, 135, 158, 108, 148, 192],
[229, 246, 217, 177, 185, 235, 191, 237, 179, 232],
[156, 140, 159, 216, 191, 228, 217, 239, 231, 254],
[151, 30, 153, 170, 155, 193, 175, 253, 242, 290],
[156, 125, 185, 212, 206, 235, 234, 250, 244, 284],
[169, 153, 180, 208, 197, 214, 211, 236, 216, 243],
[139, 123, 159, 188, 166, 199, 191, 244, 211, 254],
[225, 224, 216, 265, 207, 218, 169, 154, 174, 202],
[269, 260, 238, 292, 226, 255, 167, 150, 189, 208],
[232, 221, 189, 245, 182, 203, 144, 114, 147, 160],
[226, 207, 202, 270, 199, 204, 158, 134, 178, 194],
[232, 227, 213, 234, 207, 224, 180, 152, 182, 200],
[138, 234, 141, 218, 168, 271, 169, 248, 193, 198],
[117, 218, 158, 198, 161, 293, 165, 252, 181, 182],
[151, 242, 167, 231, 187, 254, 192, 245, 195, 208],
[107, 207, 123, 198, 135, 237, 157, 213, 168, 186],
[165, 223, 169, 219, 189, 267, 191, 264, 192, 195],
[115, 171, 154, 181, 226, 123, 245, 189, 251, 237],
[171, 115, 154, 181, 226, 123, 245, 189, 251, 237],
[171, 154, 115, 181, 226, 123, 245, 189, 251, 237],
[171, 154, 181, 226, 226, 123, 245, 189, 251, 237],
[171, 154, 181, 115, 115, 123, 245, 189, 251, 237]
]];

}

?>

