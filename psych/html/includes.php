<?php

function get_time()
{
	date_default_timezone_set("America/New_York");
        return date("Y-m-d H:i:s");
}

function get_points($phase, $sequence, $answer)
{
	if(!session_id())
		session_start();

	if(!isset($_SESSION["testing_data"]))
		return 0;

	$arr = $_SESSION["testing_data"][$phase][$sequence];
        sort($arr);

        $a = intval($answer);

        $p = 0;

        if($arr[0] == $a)
                $p = 3;
	else if($arr[1] == $a)
	        $p = 2;
	else if($arr[2] == $a || $arr[3] ==$a || $arr[4] ==$a)
		$p = 1;

	return $p;
}

function submit_response($arr)
{
	$log = fopen("./log.txt", "a");
	fwrite($log, json_encode($arr) . "\n\n");
	fclose($log);

	$conn = dbConnect();

	$result = dbQuery($conn, "INSERT INTO responses SET start_time=:start_time, end_time=:end_time, phase_order=:phase_order, age=:age, gender=:gender, tries=:tries, during=:during, points_phase0=:points_phase0, points_phase1=:points_phase1", [
			"start_time" => $arr["start_time"],
			"end_time" => $arr["end_time"],
			"phase_order" => $_SESSION["phase_order"],
                	"age" => $arr["age"],
                	"gender" => $arr["gender"],
                	"tries" => $arr["tries"],
                	"during" => $arr["during"],
			"points_phase0" => $arr["points_phase0"],
			"points_phase1" => $arr["points_phase1"],
	]);

	$id = $conn->lastInsertId();

	foreach($arr["data"] as $trial)
	{
		if($trial["trial_type"] == "bar-choose")
		{
			foreach($trial["responses"] as $bar_response)
			{
				dbQuery($conn, "INSERT INTO bar_responses SET response=:value, offby=:offby, category=:category, category_index=:category_index, RID=$id, phase=" . $trial["phase"] . ", number=" . $trial["number"], $bar_response);
			}
		}
		else if($trial["trial_type"] == "ticket-choose" && $trial["sequence"] > -1)
		{
//			var_dump($trial);
			dbQuery($conn, "INSERT INTO test_responses SET response=:result, points=:points, phase=:phase, sequence=:sequence, place=:place, RID=$id", [
					"result" => $trial["result"],
					"points" => $trial["points"],
					"phase" => $trial["phase"],
					"sequence" => $trial["sequence"],
					"place" => $trial["place"]
			]);
		}
		else if($trial["trial_type"] == "training_avg")
		{
			dbQuery($conn, "INSERT INTO training_responses SET sequence=:sequence, RID=$id, avg=:avg, response=:response, phase=:phase", [
					"sequence" => $trial["sequence"],
					"avg" => $trial["avg"],
					"response" => $trial["response"],
					"phase" => $trial["phase"]
			]);
		}
	}
}

function dbConnect() {
    $dsn = "mysql:host=localhost;dbname=tickets_responses;charset=utf8";
    $opts = [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_ERRMODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false,
    ];
    $conn = new PDO($dsn, "tickets_user", "hats6789", $opts);
    return $conn;
}
function dbQuery($conn, $query, $values = array()) {
    if (isset($values)) {
        $stmt = $conn->prepare($query);
        $stmt->execute($values);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
    else {
        $stmt = $conn->query($query);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
}

function startSession() {

$_SESSION = array();

$_SESSION["points"] = [];
$_SESSION["points"][0] = 0;
$_SESSION["points"][1] = 0;
$_SESSION["checked"] = [];
$_SESSION["checked"][0] = $_SESSION["checked"][1] = [];
$_SESSION["got_data"] = 0;
$_SESSION["finished"] = 0;
$_SESSION["checked_assoc"] = [];
$_SESSION["checked_assoc"][0] = $_SESSION["checked_assoc"][1] = [];

$_SESSION["start_time"] = get_time();

$_SESSION["training_data"] = [[
[168, 210, 158, 176, 182, 192, 174, 186, 178, 181],
[185, 237, 191, 177, 201, 154, 181, 196, 162, 195],
[182, 161, 190, 159, 197, 229, 184, 197, 174, 208],
[183, 154, 186, 177, 193, 185, 221, 174, 168, 132],
[185, 168, 194, 203, 198, 140, 172, 168, 188, 199]
], [
[190, 105, 220, 151, 111, 213, 261, 183, 211, 191],
[146, 127, 262, 226, 189, 128, 250, 228, 242, 188],
[156, 193, 233, 205, 154, 235, 208, 200, 182, 219],
[236, 184, 224, 280, 227, 143, 233, 210, 192, 170],
[164, 233, 158, 213, 220, 274, 177, 202, 170, 209]
]];

$_SESSION["training_answers"] = [
// First training phase
[1, 3, 8, 4, 3, 1, 0], //[3, 7, 20, 10, 7, 2, 1]
// Second training phase
[1, 2, 2, 5, 5, 3, 2] // [4, 4, 6, 12, 13, 7, 4]
];

$_SESSION["training_categories"] = [
["$135 - $150", "$151 - $165", "$166 - 180", "$181 - $195", "$196 - $210", "$211 - $225", "$226 - $240"],
["$105 - $130", "$131 - $155", "$156 - $180", "$181 - $205", "$206 - $230", "$231 - $255", "$256 - $280"]
];

$_SESSION["testing_data"] = [[
	[191, 168, 200, 169, 149, 209, 187, 171, 165, 150],
	[183, 213, 138, 190, 186, 209, 178, 194, 165, 193],
	[192, 158, 184, 208, 188, 226, 181, 198, 169, 217],
	[184, 180, 224, 165, 181, 199, 185, 193, 218, 126],
	[165, 163, 166, 201, 185, 179, 156, 204, 202, 214],
	[154, 140, 157, 186, 167, 192, 188, 197, 195, 217],
	[176, 143, 179, 185, 184, 196, 187, 202, 201, 211],
	[154, 145, 155, 168, 161, 185, 173, 191, 188, 199],
	[162, 157, 170, 176, 175, 191, 182, 200, 195, 203],
	[151, 148, 157, 165, 163, 171, 167, 187, 186, 220],
	[195, 194, 190, 224, 188, 193, 164, 161, 173, 187],
	[191, 187, 173, 205, 170, 183, 164, 159, 165, 168],
	[203, 196, 188, 210, 182, 194, 138, 128, 152, 174],
	[210, 196, 183, 213, 182, 184, 160, 149, 162, 179],
	[205, 202, 200, 207, 196, 201, 146, 137, 175, 182],
	[171, 205, 165, 201, 174, 213, 144, 206, 184, 191],
	[169, 197, 162, 187, 173, 208, 155, 206, 174, 181],
	[168, 187, 155, 181, 161, 199, 148, 194, 172, 174],
	[172, 204, 154, 195, 168, 227, 144, 211, 184, 185],
	[174, 190, 165, 188, 172, 200, 154, 198, 177, 180],
	[152, 182, 192, 173, 177, 168, 186, 184, 191, 187],
	[183, 153, 193, 174, 178, 169, 187, 185, 192, 188],
	[183, 193, 152, 174, 178, 169, 187, 185, 192, 188],
	[181, 191, 172, 150, 176, 167, 185, 183, 190, 186],
	[184, 194, 175, 179, 153, 170, 188, 186, 193, 189],
	[171, 185, 195, 176, 180, 155, 189, 187, 194, 190],
	[153, 183, 193, 174, 178, 169, 187, 185, 192, 188],
	[181, 151, 191, 172, 176, 167, 185, 183, 190, 186],
	[182, 192, 151, 173, 177, 168, 186, 184, 191, 187],
	[183, 193, 174, 152, 178, 169, 187, 185, 192, 188],
	[185, 195, 176, 180, 154, 171, 189, 187, 194, 190],
	[175, 198, 179, 183, 157, 174, 192, 190, 197, 193],
	[202, 203, 195, 185, 182, 172, 166, 178, 141, 164],
	[194, 213, 192, 182, 181, 166, 165, 174, 139, 152],
	[206, 224, 203, 186, 183, 169, 164, 178, 155, 160],
	[211, 233, 208, 189, 185, 175, 172, 180, 145, 171],
	[196, 197, 189, 179, 176, 166, 160, 172, 135, 158],
	[188, 207, 186, 176, 175, 160, 159, 168, 133, 146],
	[210, 196, 183, 213, 182, 184, 160, 149, 162, 179],
	[200, 218, 197, 180, 177, 163, 158, 172, 149, 154],
	[205, 227, 202, 183, 179, 169, 166, 174, 139, 165],
	[195, 204, 189, 182, 180, 168, 161, 170, 145, 158],
	[148, 187, 155, 181, 161, 199, 168, 194, 172, 174],
	[144, 204, 154, 195, 168, 227, 172, 211, 184, 185],
	[154, 190, 165, 188, 172, 200, 174, 198, 177, 180],
	[163, 185, 168, 191, 196, 166, 199, 195, 227, 198],
	[185, 163, 168, 191, 196, 166, 199, 195, 227, 198],
	[185, 168, 163, 191, 196, 166, 199, 195, 227, 198],
	[185, 168, 191, 163, 196, 166, 199, 195, 227, 198],
	[185, 168, 191, 196, 163, 166, 199, 195, 227, 198]
	], [
	[222, 176, 240, 178, 138, 258, 214, 182, 170, 140],
	[206, 266, 116, 220, 212, 258, 196, 228, 170, 226],
	[224, 156, 208, 256, 216, 292, 202, 236, 178, 274],
	[208, 200, 288, 170, 202, 238, 210, 226, 276, 110],
	[170, 166, 172, 242, 210, 198, 152, 248, 244, 268],
	[148, 120, 154, 212, 174, 224, 216, 234, 230, 274],
	[192, 126, 198, 210, 208, 232, 214, 244, 242, 262],
	[148, 130, 150, 176, 162, 210, 186, 222, 216, 238],
	[164, 154, 180, 192, 190, 222, 204, 240, 230, 246],
	[142, 136, 154, 170, 166, 182, 174, 214, 212, 280],
	[230, 228, 220, 288, 216, 226, 168, 162, 186, 214],
	[222, 214, 186, 250, 180, 206, 168, 158, 170, 176],
	[246, 232, 216, 260, 204, 228, 116, 100, 144, 188],
	[260, 232, 206, 266, 204, 208, 160, 138, 164, 198],
	[250, 244, 240, 254, 232, 242, 132, 114, 190, 204],
	[182, 250, 170, 242, 188, 266, 128, 252, 208, 222],
	[178, 234, 164, 214, 186, 256, 150, 252, 188, 202],
	[176, 214, 150, 202, 162, 238, 136, 228, 184, 188],
	[184, 248, 148, 230, 176, 294, 128, 262, 208, 210],
	[188, 220, 170, 216, 184, 240, 148, 236, 194, 200],
	[144, 204, 224, 186, 194, 176, 212, 208, 222, 214],
	[206, 146, 226, 188, 196, 178, 214, 210, 224, 216],
	[206, 226, 144, 188, 196, 178, 214, 210, 224, 216],
	[202, 222, 184, 140, 192, 174, 210, 206, 220, 212],
	[208, 228, 190, 198, 146, 180, 216, 212, 226, 218],
	[182, 210, 230, 192, 200, 150, 218, 214, 228, 220],
	[146, 206, 226, 188, 196, 178, 214, 210, 224, 216],
	[204, 224, 142, 186, 194, 176, 212, 208, 222, 214],
	[206, 226, 188, 144, 196, 178, 214, 210, 224, 216],
	[210, 230, 192, 200, 148, 182, 218, 214, 228, 220],
	[189, 236, 198, 206, 154, 188, 224, 220, 234, 226],
	[244, 246, 230, 210, 204, 184, 172, 196, 122, 168],
	[228, 266, 224, 204, 202, 172, 170, 188, 118, 144],
	[252, 288, 246, 212, 206, 178, 168, 196, 150, 160],
	[262, 306, 256, 218, 210, 190, 184, 200, 130, 182],
	[232, 234, 218, 198, 192, 172, 160, 184, 110, 156],
	[216, 254, 212, 192, 190, 160, 158, 176, 106, 132],
	[260, 232, 206, 266, 204, 208, 160, 138, 164, 198],
	[240, 276, 234, 200, 194, 166, 156, 184, 138, 148],
	[250, 294, 244, 206, 198, 178, 172, 188, 118, 170],
	[230, 248, 218, 204, 200, 176, 162, 180, 130, 156],
	[136, 214, 150, 202, 162, 238, 176, 228, 184, 188],
	[128, 248, 148, 230, 176, 294, 184, 262, 208, 210],
	[148, 220, 170, 216, 184, 240, 188, 236, 194, 200],
	[166, 210, 176, 222, 232, 172, 238, 230, 294, 236],
	[210, 166, 176, 222, 232, 172, 238, 230, 294, 236],
	[210, 176, 166, 222, 232, 172, 238, 230, 294, 236],
	[210, 176, 222, 166, 232, 172, 238, 230, 294, 236],
	[210, 176, 222, 232, 166, 172, 238, 230, 294, 236]
	]];

/*
$_SESSION["testing_data"] = [[
[191, 168, 200, 169, 149, 209, 187, 171, 165, 150],
[183, 213, 138, 190, 186, 209, 178, 194, 165, 193],
[192, 158, 184, 208, 188, 226, 181, 198, 169, 217],
[184, 180, 224, 165, 181, 199, 185, 193, 218, 126],
[165, 163, 166, 201, 185, 179, 156, 204, 202, 214],
[154, 140, 157, 186, 167, 192, 188, 197, 195, 217],
[176, 143, 179, 185, 184, 196, 187, 202, 201, 211],
[154, 145, 155, 168, 161, 185, 173, 191, 188, 199],
[162, 157, 170, 176, 175, 191, 182, 200, 195, 203],
[151, 148, 157, 165, 163, 171, 167, 187, 186, 220],
[195, 194, 190, 224, 188, 193, 164, 161, 173, 187],
[191, 187, 173, 205, 170, 183, 164, 159, 165, 168],
[203, 196, 188, 210, 182, 194, 138, 128, 152, 174],
[210, 196, 183, 213, 182, 184, 160, 149, 162, 179],
[205, 202, 200, 207, 196, 201, 146, 137, 175, 182],
[144, 205, 165, 201, 171, 213, 174, 206, 184, 191],
[155, 197, 162, 187, 169, 208, 173, 206, 174, 181],
[148, 187, 155, 181, 161, 199, 168, 194, 172, 174],
[144, 204, 154, 195, 168, 227, 172, 211, 184, 185],
[154, 190, 165, 188, 172, 200, 174, 198, 177, 180],
[163, 185, 168, 191, 196, 166, 199, 195, 227, 198],
[185, 163, 168, 191, 196, 166, 199, 195, 227, 198],
[185, 168, 163, 191, 196, 166, 199, 195, 227, 198],
[185, 168, 191, 163, 196, 166, 199, 195, 227, 198],
[185, 168, 191, 196, 163, 166, 199, 195, 227, 198],
[191, 168, 200, 169, 149, 209, 187, 171, 165, 150],
[183, 213, 138, 190, 186, 209, 178, 194, 165, 193],
[192, 158, 184, 208, 188, 226, 181, 198, 169, 217],
[184, 180, 224, 165, 181, 199, 185, 193, 218, 126],
[165, 163, 166, 201, 185, 179, 156, 204, 202, 214],
[154, 140, 157, 186, 167, 192, 188, 197, 195, 217],
[176, 143, 179, 185, 184, 196, 187, 202, 201, 211],
[154, 145, 155, 168, 161, 185, 173, 191, 188, 199],
[162, 157, 170, 176, 175, 191, 182, 200, 195, 203],
[151, 148, 157, 165, 163, 171, 167, 187, 186, 220],
[195, 194, 190, 224, 188, 193, 164, 161, 173, 187],
[191, 187, 173, 205, 170, 183, 164, 159, 165, 168],
[203, 196, 188, 210, 182, 194, 138, 128, 152, 174],
[210, 196, 183, 213, 182, 184, 160, 149, 162, 179],
[205, 202, 200, 207, 196, 201, 146, 137, 175, 182],
[144, 205, 165, 201, 171, 213, 174, 206, 184, 191],
[155, 197, 162, 187, 169, 208, 173, 206, 174, 181],
[148, 187, 155, 181, 161, 199, 168, 194, 172, 174],
[144, 204, 154, 195, 168, 227, 172, 211, 184, 185],
[154, 190, 165, 188, 172, 200, 174, 198, 177, 180],
[163, 185, 168, 191, 196, 166, 199, 195, 227, 198],
[185, 163, 168, 191, 196, 166, 199, 195, 227, 198],
[185, 168, 163, 191, 196, 166, 199, 195, 227, 198],
[185, 168, 191, 163, 196, 166, 199, 195, 227, 198],
[185, 168, 191, 196, 163, 166, 199, 195, 227, 198]
], [
[219, 222, 305, 181, 165, 170, 188, 187, 195, 215],
[141, 225, 160, 141, 198, 266, 199, 228, 194, 187],
[187, 209, 264, 118, 159, 171, 162, 210, 177, 254],
[207, 196, 268, 185, 208, 135, 158, 108, 148, 192],
[229, 246, 217, 177, 185, 235, 191, 237, 179, 232],
[156, 140, 159, 216, 191, 228, 217, 239, 231, 254],
[151, 160, 153, 170, 155, 193, 175, 253, 242, 290],
[156, 125, 185, 212, 206, 235, 234, 250, 244, 284],
[169, 153, 180, 208, 197, 214, 211, 236, 216, 243],
[139, 123, 159, 188, 166, 199, 191, 244, 211, 254],
[225, 224, 216, 265, 207, 218, 169, 154, 174, 202],
[269, 260, 238, 292, 226, 255, 167, 150, 189, 208],
[232, 221, 189, 245, 182, 203, 144, 114, 147, 160],
[226, 207, 202, 270, 199, 204, 158, 134, 178, 194],
[232, 227, 213, 234, 207, 224, 180, 152, 182, 200],
[138, 234, 141, 218, 168, 271, 169, 248, 193, 198],
[117, 218, 158, 198, 161, 293, 165, 252, 181, 182],
[151, 242, 167, 231, 187, 254, 192, 245, 195, 208],
[107, 207, 123, 198, 135, 237, 157, 213, 168, 186],
[165, 223, 169, 219, 189, 267, 191, 264, 192, 195],
[115, 171, 154, 181, 226, 123, 245, 189, 251, 237],
[171, 115, 154, 181, 226, 123, 245, 189, 251, 237],
[171, 154, 115, 181, 226, 123, 245, 189, 251, 237],
[171, 154, 181, 226, 226, 123, 245, 189, 251, 237],
[171, 154, 181, 115, 115, 123, 245, 189, 251, 237],
[219, 222, 305, 181, 165, 170, 188, 187, 195, 215],
[141, 225, 160, 141, 198, 266, 199, 228, 194, 187],
[187, 209, 264, 118, 159, 171, 162, 210, 177, 254],
[207, 196, 268, 185, 208, 135, 158, 108, 148, 192],
[229, 246, 217, 177, 185, 235, 191, 237, 179, 232],
[156, 140, 159, 216, 191, 228, 217, 239, 231, 254],
[151, 140, 153, 170, 155, 193, 175, 253, 242, 290],
[156, 125, 185, 212, 206, 235, 234, 250, 244, 284],
[169, 153, 180, 208, 197, 214, 211, 236, 216, 243],
[139, 123, 159, 188, 166, 199, 191, 244, 211, 254],
[225, 224, 216, 265, 207, 218, 169, 154, 174, 202],
[269, 260, 238, 292, 226, 255, 167, 150, 189, 208],
[232, 221, 189, 245, 182, 203, 144, 114, 147, 160],
[226, 207, 202, 270, 199, 204, 158, 134, 178, 194],
[232, 227, 213, 234, 207, 224, 180, 152, 182, 200],
[138, 234, 141, 218, 168, 271, 169, 248, 193, 198],
[117, 218, 158, 198, 161, 293, 165, 252, 181, 182],
[151, 242, 167, 231, 187, 254, 192, 245, 195, 208],
[107, 207, 123, 198, 135, 237, 157, 213, 168, 186],
[165, 223, 169, 219, 189, 267, 191, 264, 192, 195],
[115, 171, 154, 181, 226, 123, 245, 189, 251, 237],
[171, 115, 154, 181, 226, 123, 245, 189, 251, 237],
[171, 154, 115, 181, 226, 123, 245, 189, 251, 237],
[171, 154, 181, 226, 226, 123, 245, 189, 251, 237],
[171, 154, 181, 115, 115, 123, 245, 189, 251, 237]
]];
*/

$_SESSION["training_avg_ranges"] = [[160, 200], [170, 230]];

$v = mt_rand(1, 2);

$_SESSION["phase_order"] = $v - 1;

if($v === 2)
{
	$temp = $_SESSION["training_data"][0];
	$_SESSION["training_data"][0] = $_SESSION["training_data"][1];
	$_SESSION["training_data"][1] = $temp;

	$temp = $_SESSION["training_answers"][0];
        $_SESSION["training_answers"][0] = $_SESSION["training_answers"][1];
        $_SESSION["training_answers"][1] = $temp;

	$temp = $_SESSION["testing_data"][0];
        $_SESSION["testing_data"][0] = $_SESSION["testing_data"][1];
        $_SESSION["testing_data"][1] = $temp;

	$temp = $_SESSION["training_categories"][0];
        $_SESSION["training_categories"][0] = $_SESSION["training_categories"][1];
        $_SESSION["training_categories"][1] = $temp;

	$temp = $_SESSION["training_avg_ranges"][0];
        $_SESSION["training_avg_ranges"][0] = $_SESSION["training_avg_ranges"][1];
        $_SESSION["training_avg_ranges"][1] = $temp;
}

}

?>
